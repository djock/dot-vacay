@using DotVacay.Core.Enums
@model DotVacay.Web.Models.TripViewModel

@{
    ViewBag.Title = Model.Title;
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="position-relative">
    <!-- Banner Image -->
    <div class="trip-banner" style="height: 400px; overflow: hidden; position: relative;">
        <img src="https://picsum.photos/seed/@Model.Id/1920/1080" class="w-100 h-100" style="object-fit: cover;" alt="Trip Banner">
        <div class="overlay" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4);"></div>
    </div>

    <!-- Trip Info Card -->
    <div class="container position-relative" style="margin-top: -100px;">
        <div class="card shadow-lg">
            <div class="card-body p-4">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                        <h1 class="mb-2">@Model.Title</h1>
                        <div class="text-muted">
                            <i class="bi bi-calendar me-2"></i>
                            @Model.StartDate.Value.ToString("MMM dd") - @Model.EndDate.Value.ToString("MMM dd, yyyy")
                        </div>
                    </div>
                    <div class="d-flex justify-content-end gap-2 mb-3">
                        <a href="@Url.Action("Index", "App")" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left"></i> Back to Trips
                        </a>
                        @if (Model.IsOwner)
                        {
                            <form asp-action="Delete" method="post" onsubmit="return confirm('Are you sure you want to delete this trip?');">
                                <input type="hidden" name="tripId" value="@Model.Id" />
                                <button type="submit" class="btn btn-danger">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </form>
                        }
                        @if (!Model.IsOwner)
                        {
                            <form asp-action="Leave" method="post" onsubmit="return confirm('Are you sure you want to leave this trip?');">
                                <input type="hidden" name="tripId" value="@Model.Id" />
                                <button type="submit" class="btn btn-warning">
                                    <i class="bi bi-box-arrow-right"></i>
                                </button>
                            </form>
                        }
                    </div>

                </div>
            </div>
            @if (!string.IsNullOrEmpty(Model.Description))
            {
                <p class="mb-0">@Model.Description</p>
            }
        </div>
    </div>
</div>
</div>

<!-- Daily Itinerary -->
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            @{
                var currentDate = Model.StartDate.Value.DateTime;
                var endDate = Model.EndDate.Value.DateTime;
                while (currentDate <= endDate)
                {
                    var dayPoints = Model.PointsOfInterest
                        .Where(p => p.StartDate.HasValue && 
                                   p.EndDate.HasValue &&
                                   currentDate.Date >= p.StartDate.Value.Date && 
                                   currentDate.Date <= p.EndDate.Value.Date)
                        .OrderBy(p => p.StartDate.Value.DateTime)
                        .ToList();
                    <div class="card mb-4 shadow-sm">
                        <div class="card-header bg-white">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">@currentDate.ToString("dddd, MMMM dd")</h5>
                                <div>
                                    <button type="button" class="btn btn-primary btn-sm" 
                                    data-bs-toggle="modal" 
                                    data-bs-target="#addPoiModal" 
                                    data-date="@currentDate.ToString("yyyy-MM-dd")">
                                        <i class="bi bi-plus"></i> Add Point of Interest
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            @if (dayPoints.Any())
                            {
                                <div class="timeline">
                                    @foreach (var poi in dayPoints)
                                    {
                                        <div class="timeline-item mb-3">
                                            <div class="d-flex">
                                                <div class="timeline-icon me-3">
                                                    @switch (poi.Type)
                                                    {
                                                        case PointOfInterestType.Hotel:
                                                            <i class="bi bi-building text-primary"></i>
                                                            break;
                                                        case PointOfInterestType.CarRental:
                                                            <i class="bi bi-car-front text-success"></i>
                                                            break;
                                                        case PointOfInterestType.Food:
                                                            <i class="bi bi-cup-hot text-warning"></i>
                                                            break;
                                                        case PointOfInterestType.PlaceToVisit:
                                                            <i class="bi bi-geo-alt text-danger"></i>
                                                            break;
                                                    }
                                                </div>
                                                <div class="timeline-content flex-grow-1">
                                                    <div class="d-flex justify-content-between">
                                                        <h6 class="mb-1">@poi.Title</h6>
                                                        <div class="d-flex align-items-center gap-2">
                                                            <small class="text-muted">
                                                                @if(poi.Type == PointOfInterestType.Hotel)
                                                                {
                                                                    if (currentDate.Date == poi.StartDate.Value.Date)
                                                                    {
                                                                        @:Check in: @poi.StartDate.Value.ToString("HH:mm")
                                                                    }
                                                                    if (currentDate.Date == poi.EndDate.Value.Date)
                                                                    {
                                                                        @:Check out: @poi.EndDate.Value.ToString("HH:mm")
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    if (currentDate.Date == poi.StartDate.Value.Date)
                                                                    {
                                                                        @poi.StartDate.Value.ToString("HH:mm")
                                                                    }
                                                                    else
                                                                    {
                                                                        <span>00:00</span>
                                                                    }
                                                                    @:-
                                                                    if(currentDate.Date == poi.EndDate.Value.Date)
                                                                                        {
                                                                        @poi.EndDate.Value.ToString("HH:mm")
                                                                    }
                                                                                        else
                                                                    {
                                                                        <span>00:00</span>
                                                                    }
                                                                }
                                                               
                                                            </small>
                                                            <button type="button" class="btn btn-sm btn-outline-primary edit-poi"
                                                                    data-poi-id="@poi.PoiId"
                                                                    data-poi-title="@poi.Title"
                                                                    data-poi-description="@poi.Description"
                                                                    data-poi-type="@poi.Type"
                                                                    data-poi-start-date="@poi.StartDate.Value.ToString("yyyy-MM-ddTHH:mm")"
                                                                    data-poi-end-date="@poi.EndDate.Value.ToString("yyyy-MM-ddTHH:mm")">
                                                                <i class="bi bi-pencil"></i>
                                                            </button>
                                                            <form asp-action="DeletePointOfInterest" method="post" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this point of interest?');">
                                                                <input type="hidden" name="poiId" value="@poi.PoiId" />
                                                                <button type="submit" class="btn btn-sm btn-outline-danger">
                                                                    <i class="bi bi-trash"></i>
                                                                </button>
                                                            </form>
                                                        </div>
                                                    </div>
                                                    @if (!string.IsNullOrEmpty(poi.Description))
                                                    {
                                                        <p class="mb-0 text-muted">@poi.Description</p>
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>
                            }
                            else
                            {
                                <div class="text-center text-muted py-3">
                                    <p class="mb-0">No points of interest added for this day.</p>
                                </div>
                            }
                        </div>
                    </div>
                    currentDate = currentDate.AddDays(1);
                }
            }
        </div>
    </div>
</div>


<!-- Add/Edit Point of Interest Modal -->
<div class="modal fade" id="addPoiModal" tabindex="-1" aria-labelledby="addPoiModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addPoiModalLabel">Add Point of Interest</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                @{
                    ViewData["TripId"] = Model.Id;
                }
                @await Html.PartialAsync("_CreatePointOfInterestForm", Model.CreatePointOfInterest)
            </div>
        </div>
    </div>
</div>

@section Styles {
    <style>
        .timeline {
            position: relative;
            padding-left: 30px;
        }

        .timeline-item {
            position: relative;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -30px;
            top: 0;
            bottom: -20px;
            width: 2px;
            background-color: #e9ecef;
        }

        .timeline-item:last-child::before {
            bottom: 0;
        }

        .timeline-icon {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f8f9fa;
            border-radius: 50%;
            border: 2px solid #e9ecef;
        }
    </style>
}

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        $(document).ready(function() {
            $('#addPoiModal').on('show.bs.modal', function (event) {
                const button = $(event.relatedTarget);
                const selectedDate = button.data('date');
                
                // Set the start and end date fields to the selected date with default times
                const startDateTime = `${selectedDate}T09:00`;
                const endDateTime = `${selectedDate}T10:00`;
                
                $('input[name="StartDate"]').val(startDateTime);
                $('input[name="EndDate"]').val(endDateTime);
            });

            // Handle edit button clicks
            $('.edit-poi').on('click', function() {
                const button = $(this);
                const modal = $('#addPoiModal');
                const form = modal.find('form');
                
                // Update modal title
                modal.find('.modal-title').text('Edit Point of Interest');
                
                // Fill in the form fields
                form.find('input[name="Title"]').val(button.data('poi-title'));
                form.find('textarea[name="Description"]').val(button.data('poi-description'));
                form.find('select[name="Type"]').val(button.data('poi-type'));
                
                // Handle dates if they exist
                if (button.data('poi-start-date')) {
                    form.find('input[name="StartDate"]').val(button.data('poi-start-date'));
                    form.find('input[name="EndDate"]').val(button.data('poi-end-date'));
                }
                
                // Add the POI ID to the form
                form.append(`<input type="hidden" name="Id" value="${button.data('poi-id')}" />`);
                
                // Show the modal
                modal.modal('show');
            });
        });
    </script>
}
